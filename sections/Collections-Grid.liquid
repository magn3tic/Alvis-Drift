{% if customer.has_account %}
  {% assign lowertags = customer.tags | downcase %}
  {% assign excluded_product_ids = settings.product_list | map: "id" %}
{% endif%}
{% assign promo = product.metafields.my_fields.promo_label %}

<section class="home-product-items product-items-sec bg-darkPurple gridCleanUp">
  <div class="sec-inner">
    <div class="container">
     {% if section.settings.topheading != blank %} <h1>{{ section.settings.topheading }}</h1>{% endif %}
       {% if section.settings.subtitle-1 != blank %}<p class="sub-title">{{ section.settings.subtitle-1}}</p>{% endif %}
      <div class="product-tabs">    
        {% assign default_collection =  section.settings.active_collection %}     
        <ul>
          {%- for block in section.blocks -%}
          {%- assign b_i = block.settings -%}
          {% assign colName = block.settings.collectionCarasoul %} 
          <li class="tabs-btn {% if colName == default_collection %}current {% endif %}{% if forloop.index > 7 %}desktop-only {% endif %}" data-tab="tab-{{ forloop.index }}">{{ b_i.collection_heading }}</li>
          {%- endfor -%}	
        </ul>
      </div>
      <div class="tabs-content">
        {%- for block in section.blocks -%}
        {%- assign b_i = block.settings -%}
        {% assign colName = block.settings.collectionCarasoul %} 
        <div id="tab-{{ forloop.index }}" class="product-items-wrap {% if colName == default_collection %}current{% endif %}">
          <div class="product-bx-outer">
            {% assign colName = b_i.collectionCarasoul %} 
            {% for product in collections[colName].products %}
            <div class="product-bx position-relative">
              <div class="product-img">
                <a href="{{ product.url }}">
                  {{ product.featured_image | image_url: width: 325, format: 'webp' | image_tag: loading: 'lazy' }}
                </a>
              </div>
              <div class="product-title"><div class="sp-t"><a href="{{ product.url }}">{{ product.title }}</a></div></div>              
        {% if settings.member-discount == "enable" %}
      <!-- For Bronze Members -->
          {% if lowertags contains 'bronze'%}
            {% if excluded_product_ids contains product.id %}
                 {% if product.compare_at_price > product.price %}
                  <div class="product-price">
                    <span class="compare-price">{{ product.compare_at_price | money | remove: '.00' | replace: ",", " " }}</span>   
                    <span class="current-price">{{ product.price | money | remove: '.00' | replace: ",", " " }}</span>
                  </div>
                  {% else %}
                    <div class="product-price excluded-disount">
                  {{ product.price | money | remove: '.00' | replace: ",", " " }}
                    </div>
                  {% endif %}
              {% else %}
                {% if product.compare_at_price > product.price %}
                  <div class="product-price">
                    <span class="compare-price">{{ product.compare_at_price | money | remove: '.00' | replace: ",", " " }}</span>
                    <span class="current-price"> {{ product.price |times:0.95 | money | remove: '.00' | replace: ",", " " }}</span>
                  </div>
                  {% else %}
                  <div class="product-price position-relative">
                    <span class="compare-price bronze-discount">{{ product.price | money | remove: '.00' | replace: ",", " " }}</span>
                    <span class="current-price">{{ product.price |times:0.95 | money | remove: '.00' | replace: ",", " " }}</span>
                  </div>
                  <div class = "bronze-{{ settings.discount-badge }}"> 
                    {% if settings.discount-badge == 'tier-text'%}Bronze Member Discount{% endif %}</div>
                  {% endif %}
             {% endif %}
             <!-- For Silver Members -->
            {% elsif lowertags contains 'silver'%}
            {% if excluded_product_ids contains product.id %}

              {% if product.compare_at_price > product.price %}
                  <div class="product-price">
                    <span class="compare-price">{{ product.compare_at_price | money | remove: '.00' | replace: ",", " " }}</span>  
                    <span class="current-price">{{ product.price | money | remove: '.00' | replace: ",", " " }}</span>
                  </div>
                  {% else %}
                    <div class="product-price excluded-disount">
                  {{ product.price | money | remove: '.00' | replace: ",", " " }}
                    </div>
                  {% endif %}
              {% else %}
                {% if product.compare_at_price > product.price %}
                  <div class="product-price">
                    <span class="compare-price">{{ product.compare_at_price | money | remove: '.00' | replace: ",", " " }}</span>  
                    <span class="current-price">{{ product.price |times:0.90 | money | remove: '.00' | replace: ",", " " }}</span>
                  </div>
                  {% else %}
                  <div class="product-price position-relative">
                    <span class="compare-price silver-discount">{{ product.price | money | remove: '.00' | replace: ",", " " }}</span> <span class="current-price">{{ product.price |times:0.90 | money | remove: '.00' | replace: ",", " " }}</span></div>
                  <div class = "silver-{{ settings.discount-badge }}"> 
                    {% if settings.discount-badge == 'tier-text'%}Silver Member Discount{% endif %}</div>
                  {% endif %}
             {% endif %}
                 <!-- For Gold Members -->
              {% elsif lowertags contains 'gold' %}
            {% if excluded_product_ids contains product.id %}
              {% if product.compare_at_price > product.price  %}
                  <div class="product-price">    
                 <span class = "compare-price-exclude-discount compare-price"> {{ product.compare_at_price  | money | remove: '.00' | replace: ",", " " }}</span>
                  <span class="product-price excluded-disount"></span>
                  <span class="current-price">{{ product.price | money | remove: '.00' | replace: ",", " " }}</span>
                </div>
                {% else %}
                <div class="product-price excluded-disount">
                  {{ product.price | money | remove: '.00' | replace: ",", " " }}
              </div>
                {% endif %}
              {% else %}
              {% if product.compare_at_price > product.price  %}
                  <div class="product-price position-relative">
                    <span class="compare-price ">{{ product.compare_at_price | money | remove: '.00' | replace: ",", " " }}</span> 
                    <span class="current-price">{{ product.price |times:0.85 | money | remove: '.00' | replace: ",", " " }}</span>
                  </div>
                {% else %}
                  <div class="product-price ">
                    <span class="compare-price silver-discount">{{ product.price | money | remove: '.00' | replace: ",", " " }}</span> {{ product.price |times:0.85 | money | remove: '.00' | replace: ",", " " }}</div>
                   <div class = "silver-{{ settings.discount-badge }}"> 
                     {% if settings.discount-badge == 'tier-text'%}Gold Member Discount{% endif %}</div>
                {% endif %}
              {% endif %} 
                
                {% else %}
            {% if product.compare_at_price > product.price %}
              <div class="product-price" {% if  settings.discount-badge == "tier-text" %}style = "margin-bottom:15px" {% endif %}>
                <span class="compare-price">{{ product.compare_at_price | money | remove: '.00' | replace: ",", " " }}</span> 
                <span class="current-price">{{ product.price | money | remove: '.00' | replace: ",", " " }}</span>
              </div>
             {% else %} 
              <div class="product-price" {% if  settings.discount-badge == "tier-text" %}style = "margin-bottom:15px" {% endif %}>{{ product.price | money | remove: '.00' | replace: ",", " " }}</div>
            {% endif %}
                {% endif %}
          {% endif %}     
              {% if promo != blank %}
                {% if section.settings.promo_badge == true %}
                  <div class="promo-badge">
                      {{ promo }}
                  </div>
                  {% else %}
                  <div class="promo-label">
                      {{ promo }}
                  </div>
                  {% endif %}
              {% endif %}
              <!-- Price per bottle -->
              {% assign price_v = product.selected_or_first_available_variant.price %}
                  {% assign price_discount_gold = product.price | times:0.90 %}
                  {% assign price_discount_silver = product.price | times:0.95 %}
                  {% assign discounted_unit_gold = price_discount_gold | divided_by:product.metafields.my_fields.cost_per_item  %}
                  {% assign discounted_unit_silver = price_discount_silver | divided_by:product.metafields.my_fields.cost_per_item  %}
                  {% assign assigned_price = price_v | divided_by: product.metafields.my_fields.cost_per_item %} 

              {% if product.metafields.my_fields.cost_per_item != blank %}
              <div class="product-price-per"> R{{ assigned_price | divided_by:100 }} per Bottle x {{ product.metafields.my_fields.cost_per_item }} <br/></div>
                {% else %}
                <div class="product-price-per">Per Case</div>
                {% endif %}
              <!-- Start Add to cart button -->
             
              <product-form class="product-form">
                <div class="product-form__error-message-wrapper" role="alert" hidden>
                  <span class="product-form__error-message"></span>
                </div>
                  {%- form 'product', product, id: product.id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                  <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                  
                  <div class="qty__wrapper">
                    QTY: <input class="quantity__input" type="number" name="quantity" id="quantity" min="1" value="1" aria-label="quantity" {%- if product.selected_or_first_available_variant.available -%}{%- else -%}disabled{%- endif -%}>                  
                  </div> 
                  <div class="product-form__buttons">
                    <button type="submit" name="add" class="btn btn-overlay" {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %} >
                      <span>
                        {%- if product.selected_or_first_available_variant.available -%}
                        BUY
                        {%- else -%}
                        {{ 'products.product.sold_out' | t }}
                        {%- endif -%}
                      </span>
                      
                      <div class="loading-overlay__spinner hidden">
                        <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                          <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                        </svg>
                      </div>
                    </button>
                  </div>
                  {%- endform -%}
                  </product-form>
              </div>
                <!-- End Add to cart button -->
              {% endfor %}
            </div>
            </div>
            {%- endfor -%}  
          </div>
        </div>
      </div>
      </section> 
    {% schema %}
    {
    "name": "Collections Grid",
    "settings": [
    {
    "type": "text",
    "id": "topheading",
    "label": "Heading"
    },
 {
        "type": "text",
        "id": "subtitle-1",
        "label": "Orange Text",
          "default":"Add Text"
      }, 	
   {
    "type": "collection",
    "id": "active_collection",
    "label": "Default active collection"
    },
    {
      "type": "checkbox",
      "id": "promo_badge",
      "default":false,
      "label": "Enable Promo Badge"
    }

    ],
    "blocks": [
    {
    "type": "item",
    "limit": 16,
    "name": "Choose Collection",
    "settings": [
    {	
    "type": "text",
    "id": "collection_heading",
    "label": "Collection Name"
    },
    {
    "type": "collection",
    "id": "collectionCarasoul",
    "label": "Choose Collection"

    }

    ]
    }

    ],
    "presets": [
    {
    "name": "Collections Grid",
    "category": "Collection",
    "blocks": [
    {
    "type": "item"
    }
    ]
    }
    ]
    }
    {% endschema %}