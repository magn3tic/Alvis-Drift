{% if customer.has_account %}
  {% assign lowertags = customer.tags | downcase %}
  {% assign excluded_product_ids = settings.product_list | map: "id" %}
  {% assign included_product_ids_second = settings.product_list_included | map: "id" %}
  {% assign included_product_ids = settings.product_list_included-second  | map: "id" %}
  {% assign included_product_ids_third = settings.product_list_included-third  | map: "id" %}
{% endif%}

<section class="shop-tabs {% if product %}sp-tabs{% endif %}" id="product-collection">  
  <div class="alcontainer">
    {% if section.settings.subtitle-1 != blank or section.settings.topheading != blank %}
      <div class="head">
        {% if section.settings.subtitle-1 != blank %}
          <div class="heading-small">{{ section.settings.subtitle-1 }}</div>
        {% endif %}

        {% if section.settings.topheading != blank %}
          <h3 class="heading">{{ section.settings.topheading }}</h3>
        {% endif %}
      </div>
    {% endif %}

    <!-- ===== Tabs Nav ===== -->
    {% unless section.settings.hide_filter %}
      {% if section.blocks.size > 1 %}
        <div class="stabs">
          <ul>
            <li>
              <button type="button" class="tabs-btn active" data-tab="tab-all">
                All Ranges
              </button>
            </li>

            {% for block in section.blocks %}
              <li>
                <button type="button" class="tabs-btn" data-tab="tab{{ forloop.index }}">
                  {{ block.settings.collection_heading }}
                </button>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endunless %}

    <!-- ===== Tabs Content ===== -->
    <div class="stabs-content">

      <div data-tab="tab-all" class="active">
        <div class="row">
          {% assign all_products = '' %}
          {% for block in section.blocks %}
            {% assign col = collections[block.settings.collectionCarasoul] %}
            {% for product in col.products %}
              <div class="col-3">
                <a href="{{ product.url }}">
                  <div class="shop-item">
                    <div class="product-thumb">
                      <div class="meta-tag" data-heading="{{ product.metafields.my_fields.wine_range | handleize }}">{{ product.metafields.my_fields.wine_range }}</div>
                      {{ product.featured_image | image_url: width: 325 | image_tag: loading: 'lazy' }}

                      {%- if product.compare_at_price > product.price -%}
                        {% assign discount_amount = product.compare_at_price | minus: product.price %}
                        <div class="product-discount">
                          SAVE<br>{{ discount_amount | money_without_trailing_zeros }}
                        </div>
                      {%- endif -%}                      
                    </div>
                    <div class="product-add-to-cart">Add case to cart <svg fill="none" height="21" viewBox="0 0 22 21" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M11 0C5.225 0 0.5 4.725 0.5 10.5C0.5 16.275 5.225 21 11 21C16.775 21 21.5 16.275 21.5 10.5C21.5 4.725 16.775 0 11 0ZM11 19.725C5.9 19.725 1.775 15.6 1.775 10.5C1.775 5.4 5.9 1.275 11 1.275C16.1 1.275 20.225 5.4 20.225 10.5C20.225 15.6 16.1 19.725 11 19.725Z" fill="white"></path><path d="M11.6 6.82495H10.4V9.89995H7.625V11.1H10.4V14.325H11.6V11.1H14.45V9.89995H11.6V6.82495Z" fill="white"></path></svg></div>                    
                    <div class="product-cat">{{ product.title }}</div>
                    {% if product.compare_at_price > product.price %}
                      <div class="product-price">
                        {{ product.price | money_without_trailing_zeros }}
                        <span>WAS <del>{{ product.compare_at_price | money_without_trailing_zeros }}</del></span>
                      </div>
                    {% else %}
                      <div class="product-price">
                        {{ product.price | money_without_trailing_zeros }}
                      </div>
                    {% endif %}
                  </div>
                </a>
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>

      <!-- INDIVIDUAL COLLECTION TABS -->
      {% for block in section.blocks %}
        {% assign col = collections[block.settings.collectionCarasoul] %}
        <div data-tab="tab{{ forloop.index }}">
          <div class="row">
            {% for product in col.products %}
              <div class="col-3">
                <a href="{{ product.url }}">
                  <div class="shop-item">
                    <div class="product-thumb">
                      <div class="meta-tag" data-heading="{{ block.settings.collection_heading | handleize }}">{{ block.settings.collection_heading }}</div>
                      {{ product.featured_image | image_url: width: 325 | image_tag: loading: 'lazy' }}
                    </div>
                    <div class="product-add-to-cart">Add case to cart <svg fill="none" height="21" viewBox="0 0 22 21" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M11 0C5.225 0 0.5 4.725 0.5 10.5C0.5 16.275 5.225 21 11 21C16.775 21 21.5 16.275 21.5 10.5C21.5 4.725 16.775 0 11 0ZM11 19.725C5.9 19.725 1.775 15.6 1.775 10.5C1.775 5.4 5.9 1.275 11 1.275C16.1 1.275 20.225 5.4 20.225 10.5C20.225 15.6 16.1 19.725 11 19.725Z" fill="white"></path><path d="M11.6 6.82495H10.4V9.89995H7.625V11.1H10.4V14.325H11.6V11.1H14.45V9.89995H11.6V6.82495Z" fill="white"></path></svg></div>                    
                    <div class="product-cat">{{ product.title }}</div>
                    {% if product.compare_at_price > product.price %}
                      <div class="product-price">
                        {{ product.price | money_without_trailing_zeros }}
                        <span>WAS <del>{{ product.compare_at_price | money_without_trailing_zeros }}</del></span>
                      </div>
                    {% else %}
                      <div class="product-price">
                        {{ product.price | money_without_trailing_zeros }}
                      </div>
                    {% endif %}
                  </div>
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const section = document.getElementById('product-collection');
  if (!section) return;

  const allTabRow = section.querySelector('[data-tab="tab-all"] .row');
  if (!allTabRow) return;

  const cards = Array.from(allTabRow.children);
  if (cards.length < 2) return;

  for (let i = cards.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [cards[i], cards[j]] = [cards[j], cards[i]];
  }

  const frag = document.createDocumentFragment();
  cards.forEach(el => frag.appendChild(el));
  while (allTabRow.firstChild) allTabRow.removeChild(allTabRow.firstChild);
  allTabRow.appendChild(frag);
});
</script>

{% schema %}
{
  "name": "Collections Grid",
  "settings": [
    {
      "type": "text",
      "id": "topheading",
      "label": "Heading"
    },
    {
      "type": "text",
      "id": "subtitle-1",
      "label": "Sub Heading"
    },
    {
      "type": "checkbox",
      "id": "hide_filter",
      "label": "Hide Filter Tabs",
      "default": false
    }
  ],
  "blocks": [
    {
      "type": "item",
      "limit": 16,
      "name": "Choose Collection",
      "settings": [
        {
          "type": "text",
          "id": "collection_heading",
          "label": "Collection Name"
        },
        {
          "type": "collection",
          "id": "collectionCarasoul",
          "label": "Choose Collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collections Grid",
      "category": "Collection",
      "blocks": [
        {
          "type": "item"
        }
      ]
    }
  ]
}
{% endschema %}